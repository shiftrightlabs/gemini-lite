name: Security Audit

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  schedule:
    # Run weekly on Monday at 9am UTC
    - cron: '0 9 * * 1'

jobs:
  security:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run read-only verification
      run: npm run verify-readonly

    - name: Check for secrets in code
      run: |
        echo "Scanning for potential secrets..."
        ! grep -r -E "(api[_-]?key|secret|password|token)['\"]?\s*[:=]\s*['\"][^'\"]{8,}" src/ || exit 1
        ! grep -r -E "(AIza|ya29\.|sk-)[A-Za-z0-9_-]{20,}" src/ || exit 1
        echo "✅ No secrets detected"

    - name: NPM audit
      run: npm audit --audit-level=moderate
      continue-on-error: true

    - name: Check for workspace boundary violations
      run: |
        echo "Checking for path traversal vulnerabilities..."
        ! grep -r "\.\./\.\." src/ || exit 1
        echo "✅ No path traversal patterns found"
